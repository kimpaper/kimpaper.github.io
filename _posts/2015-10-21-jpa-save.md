---
layout: post
title: spring jpa 저장
date: '2015-10-21T16:20:00.001-08:00'
author: 페이퍼
tags: spring jpa
header-img: "img/post-bg-03.jpg"
---
jpa에서는 저장시 repository.save 함수를 이용하여 저장합니다 

```Member``` class처럼 @OneToMany나 @ManyToOne 필드들을 함께 저장 할 수 있습니다.

#### Member.java
```java
@Entity 
@Table(name = "tb_member")
public class Member {
    @Id 
    @GeneratedValue(strategy = GenerationType.AUTO)
    @Column(name = "member_seq")
    public Integer memberSeq;

    @Column
    public String nickname;
    
    @Expose
    @OneToMany(
            targetEntity = MemberInter.class
            , cascade = CascadeType.ALL
            , fetch = FetchType.EAGER
            , mappedBy = "memberSeq")
    public List<MemberInter> memberInterList;
}
```

#### MemberInter.java
```java
@Entity 
@Table(name="tb_member_inter") 
@IdClass(value = MemberInterPk.class)
public class MemberInter {
    @Id 
    @Column(name = "member_seq")
    public Integer memberSeq;
    
    @Id 
    @Column(name = "inter_seq")
    public Integer interSeq;
    
    @ManyToOne(
            targetEntity = Inter.class
            ,cascade = CascadeType.ALL
            ,fetch = FetchType.LAZY
            ,optional = false
    )
    @JoinColumn(name = "inter_seq", referencedColumnName = "inter_seq"
            , insertable = false, updatable = false)
    public Inter inter;
}
```
> @JoinColumn에 insertable, updateable을 추가 하여 false 했습니다 


#### Test method
```java
@Test
public void testSave() throws Exception{
    logger.info("------------ jpa test starting.... ------------------------");
    
    Member data = memberRepository.findByNickname("111");
    logger.info("data={}", gson.toJson(data));
    
    data.nickname = "222";
    
    MemberInter memberInter = new MemberInter();
    memberInter.interSeq = 28;
    memberInter.memberSeq = data.memberSeq;

    MemberInter memberInter2 = new MemberInter();
    memberInter2.interSeq = 29;
    memberInter2.memberSeq = data.memberSeq;

    data.memberInterList.add(memberInter);
    data.memberInterList.add(memberInter2);
    
    // 실제 저장. (member클래스를 저장. 한다)
    memberRepository.save(data);
    
    logger.info("------------ jpa test ended....    ------------------------");
}
```

#### 위 test method를 실행하면 아래와 같이 sql가 실행됩니다
```sql 
Hibernate: select member0_.member_seq as member_s1_1_, member0_.agree_yn as agree_yn2_1_, member0_.area as area3_1_, member0_.birth_year as birth_ye4_1_, member0_.country as country5_1_, member0_.del_yn as del_yn6_1_, member0_.device_token as device_t7_1_, member0_.device_uuid as device_u8_1_, member0_.gender as gender9_1_, member0_.intro as intro10_1_, member0_.nickname as nicknam11_1_, member0_.push_yn as push_yn12_1_, member0_.reg_date as reg_dat13_1_, member0_.unreg_date as unreg_d14_1_ from tb_member member0_ where member0_.nickname=?
Hibernate: select memberinte0_.member_seq as member_s2_1_0_, memberinte0_.inter_seq as inter_se1_2_0_, memberinte0_.member_seq as member_s2_2_0_, memberinte0_.inter_seq as inter_se1_2_1_, memberinte0_.member_seq as member_s2_2_1_ from tb_member_inter memberinte0_ where memberinte0_.member_seq=?
[INFO ] 16:14:02.020 [main] delim.app.service.TestServiceTest - data={"device_uuid":"353871061021777-e88c0602b30037f4","device_token":"APA91bE3Z9cRn0cqjRuahHazpYS02KTRZm5ZdeRoKVgJpn-XaYpLBVZg1b1XXKFwDY9ZUQN06yIctBCrsEXlyGaEG66qg3ISHUivQ1F09Wg5GnLHnPOfr9wus1tOSNBqNhrEMIccseGr1M2nHtjyR2aBHQsbCJmpag","push_yn":"Y","nickname":"111","gender":"M","birth_year":"1980","country":"KR","area":"01","intro":"","reg_date":"20151007174757","del_yn":"N","agree_yn":"Y","memberInterList":[{},{},{},{}]}
Hibernate: select member0_.member_seq as member_s1_1_2_, member0_.agree_yn as agree_yn2_1_2_, member0_.area as area3_1_2_, member0_.birth_year as birth_ye4_1_2_, member0_.country as country5_1_2_, member0_.del_yn as del_yn6_1_2_, member0_.device_token as device_t7_1_2_, member0_.device_uuid as device_u8_1_2_, member0_.gender as gender9_1_2_, member0_.intro as intro10_1_2_, member0_.nickname as nicknam11_1_2_, member0_.push_yn as push_yn12_1_2_, member0_.reg_date as reg_dat13_1_2_, member0_.unreg_date as unreg_d14_1_2_, memberinte1_.member_seq as member_s2_1_4_, memberinte1_.inter_seq as inter_se1_2_4_, memberinte1_.member_seq as member_s2_2_4_, memberinte1_.inter_seq as inter_se1_2_0_, memberinte1_.member_seq as member_s2_2_0_, inter2_.inter_seq as inter_se1_0_1_, inter2_.inter_name_en as inter_na2_0_1_, inter2_.inter_name_ko as inter_na3_0_1_ from tb_member member0_ left outer join tb_member_inter memberinte1_ on member0_.member_seq=memberinte1_.member_seq left outer join tb_inter inter2_ on memberinte1_.inter_seq=inter2_.inter_seq where member0_.member_seq=?
Hibernate: select memberinte0_.inter_seq as inter_se1_2_1_, memberinte0_.member_seq as member_s2_2_1_, inter1_.inter_seq as inter_se1_0_0_, inter1_.inter_name_en as inter_na2_0_0_, inter1_.inter_name_ko as inter_na3_0_0_ from tb_member_inter memberinte0_ inner join tb_inter inter1_ on memberinte0_.inter_seq=inter1_.inter_seq where memberinte0_.inter_seq=? and memberinte0_.member_seq=?
Hibernate: select memberinte0_.inter_seq as inter_se1_2_1_, memberinte0_.member_seq as member_s2_2_1_, inter1_.inter_seq as inter_se1_0_0_, inter1_.inter_name_en as inter_na2_0_0_, inter1_.inter_name_ko as inter_na3_0_0_ from tb_member_inter memberinte0_ inner join tb_inter inter1_ on memberinte0_.inter_seq=inter1_.inter_seq where memberinte0_.inter_seq=? and memberinte0_.member_seq=?
Hibernate: insert into tb_member_inter (inter_seq, member_seq) values (?, ?)
Hibernate: insert into tb_member_inter (inter_seq, member_seq) values (?, ?)
Hibernate: update tb_member set nickname=? where member_seq=?
```

로그에서 insert into가 두번 호출 되고 update도 한번 실행되는것을 확인 할 수 있습니다.



